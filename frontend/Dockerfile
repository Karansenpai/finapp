# Stage 1: Build the app
FROM node:18 AS builder

# Set working directory
WORKDIR /app

# Define build arguments for environment variables
ARG NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
ARG CLERK_SECRET_KEY
ARG NEXT_PUBLIC_CLERK_SIGN_IN_URL
ARG NEXT_PUBLIC_CLERK_SIGN_UP_URL
ARG VITE_GEMINI_API_KEY
ARG NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
ARG NEXT_PUBLIC_API_URL
ARG NEXT_PUBLIC_ML_API_URL
ARG NEXT_PUBLIC_MARKET_DATA_URL
ARG NEXT_PUBLIC_MARKET_DATA_API_KEY

# Set environment variables
ENV NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=$NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
ENV CLERK_SECRET_KEY=$CLERK_SECRET_KEY
ENV NEXT_PUBLIC_CLERK_SIGN_IN_URL=$NEXT_PUBLIC_CLERK_SIGN_IN_URL
ENV NEXT_PUBLIC_CLERK_SIGN_UP_URL=$NEXT_PUBLIC_CLERK_SIGN_UP_URL
ENV VITE_GEMINI_API_KEY=$VITE_GEMINI_API_KEY
ENV NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=$NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
ENV NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL
ENV NEXT_PUBLIC_ML_API_URL=$NEXT_PUBLIC_ML_API_URL
ENV NEXT_PUBLIC_MARKET_DATA_URL=$NEXT_PUBLIC_MARKET_DATA_URL
ENV NEXT_PUBLIC_MARKET_DATA_API_KEY=$NEXT_PUBLIC_MARKET_DATA_API_KEY

# Copy package files and install dependencies
COPY package*.json ./
RUN npm install

# Copy all files
COPY . .

# Create .env file with environment variables
RUN echo "NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=$NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY" > .env && \
    echo "CLERK_SECRET_KEY=$CLERK_SECRET_KEY" >> .env && \
    echo "NEXT_PUBLIC_CLERK_SIGN_IN_URL=$NEXT_PUBLIC_CLERK_SIGN_IN_URL" >> .env && \
    echo "NEXT_PUBLIC_CLERK_SIGN_UP_URL=$NEXT_PUBLIC_CLERK_SIGN_UP_URL" >> .env && \
    echo "VITE_GEMINI_API_KEY=$VITE_GEMINI_API_KEY" >> .env && \
    echo "NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=$NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY" >> .env && \
    echo "NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL" >> .env && \
    echo "NEXT_PUBLIC_ML_API_URL=$NEXT_PUBLIC_ML_API_URL" >> .env && \
    echo "NEXT_PUBLIC_MARKET_DATA_URL=$NEXT_PUBLIC_MARKET_DATA_URL" >> .env && \
    echo "NEXT_PUBLIC_MARKET_DATA_API_KEY=$NEXT_PUBLIC_MARKET_DATA_API_KEY" >> .env

# Build the Next.js app
RUN npm run build

# Stage 2: Run the app using a lightweight image
FROM node:18-alpine AS runner

WORKDIR /app

# Define build arguments for environment variables
ARG NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
ARG CLERK_SECRET_KEY
ARG NEXT_PUBLIC_CLERK_SIGN_IN_URL
ARG NEXT_PUBLIC_CLERK_SIGN_UP_URL
ARG VITE_GEMINI_API_KEY
ARG NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
ARG NEXT_PUBLIC_API_URL
ARG NEXT_PUBLIC_ML_API_URL
ARG NEXT_PUBLIC_MARKET_DATA_URL
ARG NEXT_PUBLIC_MARKET_DATA_API_KEY

# Set environment variables for runtime
ENV NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=$NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY
ENV CLERK_SECRET_KEY=$CLERK_SECRET_KEY
ENV NEXT_PUBLIC_CLERK_SIGN_IN_URL=$NEXT_PUBLIC_CLERK_SIGN_IN_URL
ENV NEXT_PUBLIC_CLERK_SIGN_UP_URL=$NEXT_PUBLIC_CLERK_SIGN_UP_URL
ENV VITE_GEMINI_API_KEY=$VITE_GEMINI_API_KEY
ENV NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=$NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY
ENV NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL
ENV NEXT_PUBLIC_ML_API_URL=$NEXT_PUBLIC_ML_API_URL
ENV NEXT_PUBLIC_MARKET_DATA_URL=$NEXT_PUBLIC_MARKET_DATA_URL
ENV NEXT_PUBLIC_MARKET_DATA_API_KEY=$NEXT_PUBLIC_MARKET_DATA_API_KEY

# Install dependencies including TypeScript
COPY --from=builder /app/package*.json ./
RUN npm install

# Create .env file in runtime environment
RUN echo "NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=$NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY" > .env && \
    echo "CLERK_SECRET_KEY=$CLERK_SECRET_KEY" >> .env && \
    echo "NEXT_PUBLIC_CLERK_SIGN_IN_URL=$NEXT_PUBLIC_CLERK_SIGN_IN_URL" >> .env && \
    echo "NEXT_PUBLIC_CLERK_SIGN_UP_URL=$NEXT_PUBLIC_CLERK_SIGN_UP_URL" >> .env && \
    echo "VITE_GEMINI_API_KEY=$VITE_GEMINI_API_KEY" >> .env && \
    echo "NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=$NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY" >> .env && \
    echo "NEXT_PUBLIC_API_URL=$NEXT_PUBLIC_API_URL" >> .env && \
    echo "NEXT_PUBLIC_ML_API_URL=$NEXT_PUBLIC_ML_API_URL" >> .env && \
    echo "NEXT_PUBLIC_MARKET_DATA_URL=$NEXT_PUBLIC_MARKET_DATA_URL" >> .env && \
    echo "NEXT_PUBLIC_MARKET_DATA_API_KEY=$NEXT_PUBLIC_MARKET_DATA_API_KEY" >> .env

# Copy built output
COPY --from=builder /app/.next .next
COPY --from=builder /app/public ./public
COPY --from=builder /app/next.config.ts ./
COPY --from=builder /app/tsconfig.json ./
COPY --from=builder /app/node_modules ./node_modules

# Expose port (optional)
EXPOSE 3000

# Start the app
CMD ["npm", "start"]
